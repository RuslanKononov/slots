<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>–°–ª–æ—Ç-–º–∞—à–∏–Ω–∞</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:black; color:gold; overflow:hidden;}
#background {position:fixed; inset:0; background-size:cover; background-position:center; filter:blur(2px) brightness(0.6); z-index:-1;}
#slotTitle {text-align:center; font-size:28px; margin:20px 0; text-shadow:0 0 10px gold;}
#slotMachine {display:grid; grid-template-columns:repeat(5,1fr); gap:10px; padding:16px;}
.reel {height:240px; overflow:hidden; border:2px solid gold; border-radius:14px; background:rgba(0,0,0,0.75); position:relative;}
.reel-track {position:absolute; top:0; width:100%; transition: transform 0.8s cubic-bezier(.1,.7,.1,1);}
.symbol {height:80px; display:flex; align-items:center; justify-content:center;}
.symbol img {max-height:70px; max-width:70px;}
#spinBtn {width:80%; margin:20px auto; display:block; font-size:26px; padding:16px; background:linear-gradient(red,darkred); color:white; border:none; border-radius:40px; box-shadow:0 0 20px red;}
#settingsBtn {position:fixed; top:10px; right:10px; font-size:24px; background:black; color:gold; border:2px solid gold; border-radius:50%; width:44px; height:44px;}
#settings {position:fixed; inset:0; background:black; color:gold; padding:20px; overflow-y:auto; z-index:10; display:none;}
#settings input, #settings button {width:100%; margin:6px 0; padding:10px; font-size:16px;}
.symbol-item {border:1px solid gold; padding:10px; margin-bottom:10px;}
#popup {position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:20;}
.popup-content {background:black; border:3px solid gold; border-radius:20px; padding:20px; text-align:center;}
.popup-content img {max-width:200px; margin:10px 0;}
</style>
</head>
<body>

<div id="background"></div>

<header id="slotTitle">–ú–û–ò –°–õ–û–¢–´</header>

<main id="slotMachine">
  <div class="reel" data-col="0"></div>
  <div class="reel" data-col="1"></div>
  <div class="reel" data-col="2"></div>
  <div class="reel" data-col="3"></div>
  <div class="reel" data-col="4"></div>
</main>

<button id="spinBtn">–ö–†–£–¢–ò–¢–¨</button>
<button id="settingsBtn">‚öôÔ∏è</button>

<div id="settings">
<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
<label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤</label>
<input id="titleInput" type="text">
<hr>
<h3>–°–∏–º–≤–æ–ª—ã</h3>
<div id="symbolsList"></div>
<button id="addSymbolBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∏–º–≤–æ–ª</button>
<hr>
<h3>–§–æ–Ω</h3>
<input type="file" accept="image/*" onchange="setBackground(event)">
<br><br>
<button id="closeSettingsBtn">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id="popup">
  <div class="popup-content">
    <h2 id="popupTitle"></h2>
    <img id="popupImage">
    <button id="popupOk">OK</button>
  </div>
  <canvas id="fireworks"></canvas>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

const slotTitle = document.getElementById("slotTitle");
const spinBtn = document.getElementById("spinBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settings = document.getElementById("settings");
const titleInput = document.getElementById("titleInput");
const symbolsList = document.getElementById("symbolsList");
const addSymbolBtn = document.getElementById("addSymbolBtn");
const closeSettingsBtn = document.getElementById("closeSettingsBtn");

const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupImage = document.getElementById("popupImage");
const popupOk = document.getElementById("popupOk");
const background = document.getElementById("background");

let state = JSON.parse(localStorage.getItem("state")) || {
  title:"–ú–û–ò –°–õ–û–¢–´",
  symbols:[
    {img:"https://via.placeholder.com/100/FF0000/FFFFFF?text=1", action:"–í—ã–∏–≥—Ä—ã—à 1", winImg:null},
    {img:"https://via.placeholder.com/100/00FF00/FFFFFF?text=2", action:"–í—ã–∏–≥—Ä—ã—à 2", winImg:null},
    {img:"https://via.placeholder.com/100/0000FF/FFFFFF?text=3", action:"–í—ã–∏–≥—Ä—ã—à 3", winImg:null},
    {img:"https://via.placeholder.com/100/FFFF00/000000?text=4", action:"–í—ã–∏–≥—Ä—ã—à 4", winImg:null},
    {img:"https://via.placeholder.com/100/FF00FF/FFFFFF?text=5", action:"–í—ã–∏–≥—Ä—ã—à 5", winImg:null},
    {img:"https://via.placeholder.com/100/00FFFF/000000?text=6", action:"–í—ã–∏–≥—Ä—ã—à 6", winImg:null},
    {img:"https://via.placeholder.com/100/FFA500/FFFFFF?text=7", action:"–í—ã–∏–≥—Ä—ã—à 7", winImg:null},
    {img:"https://via.placeholder.com/100/808080/FFFFFF?text=8", action:"–í—ã–∏–≥—Ä—ã—à 8", winImg:null}
  ],
  background:"https://via.placeholder.com/800x600/222222/AAAAAA?text=–§–û–ù",
  sounds:{win:null,lose:null}
};

applyBackground();
slotTitle.innerText = state.title;

// ---------- SETTINGS ----------
settingsBtn.onclick = ()=>{ settings.style.display="block"; renderSettings(); }
closeSettingsBtn.onclick = ()=>{ settings.style.display="none"; slotTitle.innerText=state.title; applyBackground(); renderSlots(); saveState(); }
addSymbolBtn.onclick = ()=>{ if(state.symbols.length>=30) return alert("–ú–∞–∫—Å–∏–º—É–º 30"); state.symbols.push({img:"",action:"",winImg:null}); renderSettings(); saveState(); }

function renderSettings(){
  titleInput.value = state.title;
  titleInput.oninput = e=>{ state.title=e.target.value; saveState(); }

  symbolsList.innerHTML="";
  state.symbols.forEach((s,i)=>{
    const div=document.createElement("div");
    div.className="symbol-item";
    div.innerHTML=`
      <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–∏–º–≤–æ–ª–∞</label>
      <input type="file" accept="image/*" onchange="loadSymbolImg(event,${i})">
      <label>–¢–µ–∫—Å—Ç –≤—ã–∏–≥—Ä—ã—à–∞</label>
      <input value="${s.action||""}" oninput="state.symbols[${i}].action=this.value; saveState()">
      <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ popup</label>
      <input type="file" accept="image/*" onchange="loadWinImg(event,${i})">
      <button onclick="removeSymbol(${i})">üóë –£–¥–∞–ª–∏—Ç—å</button>
    `;
    symbolsList.appendChild(div);
  });
}

window.loadSymbolImg=(e,i)=>{ const r=new FileReader(); r.onload=()=>{state.symbols[i].img=r.result; saveState();}; r.readAsDataURL(e.target.files[0]); }
window.loadWinImg=(e,i)=>{ const r=new FileReader(); r.onload=()=>{state.symbols[i].winImg=r.result; saveState();}; r.readAsDataURL(e.target.files[0]); }
window.setBackground=(e)=>{ const r=new FileReader(); r.onload=()=>{state.background=r.result; applyBackground(); saveState();}; r.readAsDataURL(e.target.files[0]); }

function removeSymbol(i){ if(state.symbols.length<=8) return alert("–ú–∏–Ω–∏–º—É–º 8"); state.symbols.splice(i,1); renderSettings(); saveState(); }

function saveState(){ localStorage.setItem("state",JSON.stringify(state)); }

// ---------- BACKGROUND ----------
function applyBackground(){ if(state.background) background.style.backgroundImage=`url(${state.background})`; }

// ---------- POPUP ----------
popupOk.onclick=()=>{ popup.style.display="none"; stopFireworks(); }
function showPopup(title,text,img){
  popupTitle.innerText = title+"\n"+text;
  if(img){ popupImage.src=img; popupImage.style.display="block"; }
  else popupImage.style.display="none";
  popup.style.display="flex";
}

// ---------- SPIN ----------
function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }
function createSymbolEl(symbol){ const div=document.createElement("div"); div.className="symbol"; const img=document.createElement("img"); img.src=symbol.img; div.appendChild(img); return div; }

spinBtn.onclick=()=>{
  if(state.symbols.length<8){ alert("–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤"); return; }
  spinBtn.disabled=true;
  const reels=document.querySelectorAll(".reel");
  const finalResult=[];
  reels.forEach((reel,colIndex)=>{
    reel.innerHTML="";
    const track=document.createElement("div"); track.className="reel-track";
    const pool=shuffle(state.symbols);
    const visible=pool.slice(0,3);
    finalResult[colIndex]=visible[1];
    const spinList=shuffle(state.symbols).concat(visible);
    spinList.forEach(s=>track.appendChild(createSymbolEl(s)));
    reel.appendChild(track);
    const offset=(spinList.length-3)*80;
    track.style.transform=`translateY(-${offset}px)`;
    setTimeout(()=>{ track.style.transitionDuration="0.8s"; track.style.transform=`translateY(-${offset}px)`; },colIndex*250);
  });
  setTimeout(()=>{ spinBtn.disabled=false; checkWinAnimated(finalResult); },250*5+900);
};

function checkWinAnimated(centerSymbols){
  const first=centerSymbols[0].img;
  const win=centerSymbols.every(s=>s.img===first);
  if(win){ showPopup("üéâ –í–´–ò–ì–†–´–®!",centerSymbols[0].action,centerSymbols[0].winImg||centerSymbols[0].img); startFireworks(); playSound("win"); }
  else{ showPopup("üòå –ù–µ –ø–æ–≤–µ–∑–ª–æ","–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ —Ç–æ—á–Ω–æ –ø–æ–≤–µ–∑—ë—Ç"); playSound("lose"); }
}

// ---------- SOUND ----------
function playSound(type){ if(!state.sounds[type]) return; const audio=new Audio(state.sounds[type]); audio.play(); }

// ---------- FIREWORKS ----------
let fw;
function startFireworks(){ 
  const c=document.getElementById("fireworks"); 
  const ctx=c.getContext("2d"); 
  c.width=innerWidth; c.height=innerHeight; 
  fw=setInterval(()=>{ ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle="gold"; ctx.beginPath(); ctx.arc(Math.random()*c.width,Math.random()*c.height,4,0,Math.PI*2); ctx.fill(); },50); 
}
function stopFireworks(){ clearInterval(fw); }

// ---------- RENDER SLOTS ----------
function renderSlots(){ 
  const reels=document.querySelectorAll(".reel"); 
  reels.forEach((reel,i)=>{ reel.innerHTML=""; const track=document.createElement("div"); track.className="reel-track"; const visible=[state.symbols[i%state.symbols.length],state.symbols[(i+1)%state.symbols.length],state.symbols[(i+2)%state.symbols.length]]; visible.forEach(s=>track.appendChild(createSymbolEl(s))); reel.appendChild(track); }); 
}
renderSlots();

});
</script>
</body>
</html>
