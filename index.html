<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Слоты</title>

<style>
body{
  margin:0;
  background:black;
  color:gold;
  font-family:Arial,sans-serif;
  overflow:hidden;
}

header{
  text-align:center;
  font-size:26px;
  padding:10px;
  text-shadow:0 0 10px gold;
}

#slotWrapper{
  position:relative;
  margin:0 auto;
  max-width:420px;
}

#slotMachine{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
  padding:10px;
}

.reel{
  height:240px;
  overflow:hidden;
  border:2px solid gold;
  border-radius:14px;
  background:rgba(0,0,0,.8);
  position:relative;
}

.reel-track{
  position:absolute;
  top:0;
  width:100%;
  transition:transform 1.5s cubic-bezier(.1,.7,.1,1);
}

.symbol{
  height:80px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.symbol img{
  width:60px;
  height:60px;
}

#lineCanvas{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:5;
}

body{
  position:relative;
}

button{
  width:80%;
  margin:15px auto;
  padding:14px;
  font-size:22px;
  border:none;
  border-radius:30px;
  background:linear-gradient(red,darkred);
  color:white;
  display:block;
}

#settingsBtn{
  position:absolute;
  top:12px;
  right:12px;
  width:44px;
  height:44px;
  border-radius:50%;
  border:2px solid gold;
  background:black;
  color:gold;
  font-size:22px;
  z-index:100;
}

#settings{
  position:fixed;
  inset:0;
  background:black;
  padding:20px;
  overflow:auto;
  z-index:30;
  display:none;
}

#settings input{
  width:100%;
  margin:6px 0;
  padding:8px;
}

.symbolItem{
  border:1px solid gold;
  padding:10px;
  margin-bottom:10px;
}

#popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:40;
}

.popup-content{
  background:black;
  border:3px solid gold;
  border-radius:18px;
  padding:20px;
  text-align:center;
}
.popup-content img{max-width:160px;}
</style>
</head>

<body>

<header id="title"></header>

<div id="slotWrapper">
  <div id="slotMachine">
    <div class="reel"></div>
    <div class="reel"></div>
    <div class="reel"></div>
    <div class="reel"></div>
    <div class="reel"></div>
  </div>
  <canvas id="lineCanvas"></canvas>
</div>

<button id="spinBtn">КРУТИТЬ</button>
<button id="settingsBtn">⚙️</button>

<div id="settings">
  <h2>Настройки</h2>
  <label>Название</label>
  <input id="titleInput">

  <label>Шанс выигрыша (%)</label>
  <input id="chanceInput" type="number" min="0" max="100">

  <h3>Символы</h3>
  <div id="symbolsList"></div>
  <button onclick="addSymbol()">➕ Добавить символ</button>

  <button onclick="closeSettings()">⬅ Назад</button>
</div>

<div id="popup">
  <div class="popup-content">
    <h2 id="popupText"></h2>
    <img id="popupImg">
    <button onclick="closePopup()">OK</button>
  </div>
</div>

<script>
/* ===== STATE ===== */
const defaultImg="https://i.imgur.com/6XgZ7QH.png";
let state=JSON.parse(localStorage.getItem("slotsState"))||{
  title:"МОИ СЛОТЫ",
  winChance:0.5,
  symbols:[
    {id:uid(), img:defaultImg, winImg:null, text:"Золото"},
    {id:uid(), img:"https://i.imgur.com/zYxDCQT.png", winImg:null, text:"Вишня"},
    {id:uid(), img:"https://i.imgur.com/BoN9kdC.png", winImg:null, text:"Алмаз"}
  ]
};
function save(){localStorage.setItem("slotsState",JSON.stringify(state));}

/* ===== UI INIT ===== */
title.innerText=state.title;
titleInput.value=state.title;
chanceInput.value=state.winChance*100;

/* ===== SETTINGS ===== */
settingsBtn.onclick=()=>{
  renderSettings();
  settings.style.display="block";
};

function closeSettings(){
  state.title = titleInput.value;
  state.winChance = Math.max(0, Math.min(1, chanceInput.value / 100));

  save();

  title.innerText = state.title;

  settings.style.display = "none";
}

function renderSettings(){
  symbolsList.innerHTML="";
  state.symbols.forEach((s,i)=>{
    const d=document.createElement("div");
    d.className="symbolItem";
    d.innerHTML=`
      <label>Картинка символа</label>
      <input type="file" accept="image/*" onchange="loadImg(event,'${s.id}','img')">
  <label>Картинка выигрыша</label>
      <input type="file" accept="image/*" onchange="loadImg(event,'${s.id}','winImg')">
      <label>Текст</label>
      <input value="${s.text||""}" oninput="state.symbols[${i}].text=this.value;save()">
    `;
    symbolsList.appendChild(d);
  });
}


function addSymbol(){
  state.symbols.push({
    id: uid(),
    img: defaultImg,
    winImg: null,
    text: ""
  });
  save();
  renderSettings();
}

function loadImg(e, id, key){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const sym = state.symbols.find(s => s.id === id);
    if(!sym) return;
    sym[key] = reader.result;
    save();
  };
  reader.readAsDataURL(file);
}

/* ===== SLOT LOGIC ===== */
const reels=document.querySelectorAll(".reel");
const canvas=lineCanvas,ctx=canvas.getContext("2d");

function resizeCanvas(){
  canvas.width=slotWrapper.clientWidth;
  canvas.height=slotWrapper.clientHeight;
}
resizeCanvas();
window.onresize=resizeCanvas;

spinBtn.onclick=spin;

function spin(){
  spinBtn.disabled=true;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const isWin=Math.random()<state.winChance;
  const winSymbol=isWin?state.symbols[Math.floor(Math.random()*state.symbols.length)]:null;
  
  let columns=[];

  reels.forEach((reel,i)=>{
    reel.innerHTML="";
    const track=document.createElement("div");
    track.className="reel-track";

    let visible=[];
    if(isWin){
      const pos=Math.floor(Math.random()*3);
      visible=[rand(),rand(),rand()];
      visible[pos]=winSymbol;
    }else{
      visible=[rand(),rand(),rand()];
    }

    columns.push(visible);
    const spinList=[...Array(10)].map(rand).concat(visible);
    spinList.forEach(s=>{
      const d=document.createElement("div");
      d.className="symbol";
      const img=document.createElement("img");
      img.src=s.img;
      d.appendChild(img);
      track.appendChild(d);
    });
    reel.appendChild(track);

    const offset=(spinList.length-3)*80;
    setTimeout(()=>track.style.transform=`translateY(-${offset}px)`,i*200);
  });

  setTimeout(()=>{
    spinBtn.disabled = false;
    const winResult = findWinningSymbol(columns);
    if (winResult) {
      drawLine(columns, winResult);
      showPopup(winResult);
    }
  },1800);
}

function findWinningSymbol(columns){
  for(const sym of state.symbols){
    if(columns.every(col => col.some(s => s.id === sym.id))){
      return sym;
    }
  }
  return null;
}

function rand(){
  const s = state.symbols[Math.floor(Math.random()*state.symbols.length)];
  return { ...s };
}

/* ===== LINE ===== */
function drawLine(cols,sym){
  ctx.strokeStyle="gold";
  ctx.lineWidth=6;
  ctx.shadowBlur=15;
  ctx.shadowColor="gold";

  let points=[];
  reels.forEach((r,i)=>{
    const row=cols[i].findIndex(s=>s.id===sym.id);
    const x=r.offsetLeft+r.offsetWidth/2;
    const y=r.offsetTop+row*80+40;
    points.push({x,y});
  });

  let i=0;
  function anim(){
    if(i>=points.length-1)return;
    ctx.beginPath();
    ctx.moveTo(points[i].x,points[i].y);
    ctx.lineTo(points[i+1].x,points[i+1].y);
    ctx.stroke();
    i++;
    setTimeout(anim,150);
  }
  anim();
}

/* ===== POPUP ===== */
function showPopup(sym){
  popupText.innerText="ВЫИГРЫШ! "+(sym.text||"");
  popupImg.src=sym.winImg||sym.img;
  popup.style.display="flex";
}
function closePopup(){
  popup.style.display="none";
  ctx.clearRect(0,0,canvas.width,canvas.height);
}


function uid(){
  return Math.random().toString(36).slice(2);
}

</script>

</body>
</html>