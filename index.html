<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ª–æ—Ç—ã</title>

<style>
body{
  margin:0;
  background:black;
  color:gold;
  font-family:Arial, sans-serif;
  overflow:hidden;
}

#slotTitle{
  text-align:center;
  font-size:26px;
  margin:10px 0;
  text-shadow:0 0 10px gold;
}

#slotWrapper{
  position:relative;
}

#slotMachine{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  padding:10px;
}

.reel{
  height:240px;
  overflow:hidden;
  border:2px solid gold;
  border-radius:12px;
  background:rgba(0,0,0,.8);
  position:relative;
}

.reel-track{
  position:absolute;
  top:0;
  width:100%;
  transition:transform 1.4s cubic-bezier(.1,.7,.1,1);
}

.symbol{
  height:80px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.symbol img{
  width:64px;
  height:64px;
}

button{
  display:block;
  width:80%;
  margin:15px auto;
  padding:14px;
  font-size:22px;
  border-radius:30px;
  border:none;
  background:linear-gradient(red,darkred);
  color:white;
}

#settingsBtn{
  position:fixed;
  top:10px;
  right:10px;
  width:44px;
  height:44px;
  border-radius:50%;
  background:black;
  color:gold;
  border:2px solid gold;
  font-size:22px;
  z-index:20;
}

#settings{
  position:fixed;
  inset:0;
  background:black;
  color:gold;
  padding:20px;
  overflow:auto;
  z-index:30;
  display:none;
}

#settings input{
  width:100%;
  padding:10px;
  margin:6px 0;
}

#popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:40;
}

.popup-content{
  background:black;
  border:3px solid gold;
  border-radius:16px;
  padding:20px;
  text-align:center;
}

.popup-content img{
  max-width:180px;
  margin:10px 0;
}

canvas{
  position:fixed;
  inset:0;
  pointer-events:none;
}

#lineCanvas{ z-index:25; }
#fireworks{ z-index:24; }
</style>
</head>

<body>

<header id="slotTitle">–ú–û–ò –°–õ–û–¢–´</header>

<div id="slotWrapper">
  <div id="slotMachine">
    <div class="reel"></div>
    <div class="reel"></div>
    <div class="reel"></div>
    <div class="reel"></div>
    <div class="reel"></div>
  </div>
  <canvas id="lineCanvas"></canvas>
</div>

<button id="spinBtn">–ö–†–£–¢–ò–¢–¨</button>
<button id="settingsBtn">‚öôÔ∏è</button>

<div id="settings">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
  <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
  <input id="titleInput">
  <label>–®–∞–Ω—Å –≤—ã–∏–≥—Ä—ã—à–∞ (%)</label>
  <input id="chanceInput" type="number" min="0" max="100">
  <button onclick="closeSettings()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id="popup">
  <div class="popup-content">
    <h2 id="popupTitle"></h2>
    <img id="popupImage">
    <button id="popupOk">OK</button>
  </div>
</div>

<canvas id="fireworks"></canvas>

<script>
/* ---------- STATE ---------- */
const defaultSymbols=[
  {id:1,img:"https://i.imgur.com/6XgZ7QH.png",action:"–ó–æ–ª–æ—Ç–æ!"},
  {id:2,img:"https://i.imgur.com/BoN9kdC.png",action:"–ê–ª–º–∞–∑!"},
  {id:3,img:"https://i.imgur.com/zYxDCQT.png",action:"–í–∏—à–Ω—è!"},
  {id:4,img:"https://i.imgur.com/L8J5y5s.png",action:"–°–µ–º—ë—Ä–∫–∞!"}
];

let state=JSON.parse(localStorage.getItem("slotState"))||{
  title:"–ú–û–ò –°–õ–û–¢–´",
  winChance:0.3,
  symbols:defaultSymbols
};

function save(){ localStorage.setItem("slotState",JSON.stringify(state)); }

/* ---------- UI ---------- */
slotTitle.innerText=state.title;
titleInput.value=state.title;
chanceInput.value=state.winChance*100;

settingsBtn.onclick=()=>settings.style.display="block";
function closeSettings(){
  state.title=titleInput.value;
  state.winChance=chanceInput.value/100;
  slotTitle.innerText=state.title;
  save();
  settings.style.display="none";
}

/* ---------- SLOT LOGIC ---------- */
const reels=document.querySelectorAll(".reel");

function createSymbol(s){
  const d=document.createElement("div");
  d.className="symbol";
  const i=document.createElement("img");
  i.src=s.img;
  d.appendChild(i);
  return d;
}

spinBtn.onclick=spin;

function spin(){
  spinBtn.disabled=true;
  clearLine();

  const isWin=Math.random()<state.winChance;
  let winSymbol=isWin?state.symbols[Math.floor(Math.random()*state.symbols.length)]:null;
  let columns=[];

  reels.forEach((reel,idx)=>{
    reel.innerHTML="";
    const track=document.createElement("div");
    track.className="reel-track";
    let visible;

    if(isWin){
      visible=[randomSymbol(),winSymbol,randomSymbol()];
    }else{
      visible=[randomSymbol(),randomSymbol(),randomSymbol()];
    }

    columns.push(visible);

    const spinList=[...Array(10)].map(randomSymbol).concat(visible);
    spinList.forEach(s=>track.appendChild(createSymbol(s)));
    reel.appendChild(track);

    const offset=(spinList.length-3)*80;
    track.style.transform="translateY(0)";
    setTimeout(()=>track.style.transform=`translateY(-${offset}px)`,idx*200);
  });

  setTimeout(()=>{
    spinBtn.disabled=false;
    checkWin(columns);
  },1600);
}

function randomSymbol(){
  return state.symbols[Math.floor(Math.random()*state.symbols.length)];
}

/* ---------- WIN CHECK ---------- */
const lineCanvas=document.getElementById("lineCanvas");
const ctx=lineCanvas.getContext("2d");
resizeCanvas();
window.onresize=resizeCanvas;

function resizeCanvas(){
  lineCanvas.width=innerWidth;
  lineCanvas.height=innerHeight;
}

function checkWin(columns){
  let symbol=state.symbols.find(s=>
    columns.every(col=>col.some(c=>c.img===s.img))
  );

  if(symbol){
    animateLine(columns,symbol);
    showPopup("üéâ –í–´–ò–ì–†–´–®!",symbol.action,symbol.img);
    startFireworks();
  }else{
    showPopup("üòå –ù–µ –ø–æ–≤–µ–∑–ª–æ","–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë");
  }
}

/* ---------- LINE ANIMATION ---------- */
function animateLine(cols,symbol){
  let points=[];
  reels.forEach((reel,i)=>{
    const row=cols[i].findIndex(s=>s.img===symbol.img);
    const r=reel.getBoundingClientRect();
    points.push({
      x:r.left+r.width/2,
      y:r.top+row*80+40
    });
  });

  ctx.strokeStyle="gold";
  ctx.lineWidth=6;
  ctx.shadowBlur=15;
  ctx.shadowColor="gold";

  let i=0;
  function draw(){
    if(i>=points.length-1)return;
    ctx.beginPath();
    ctx.moveTo(points[i].x,points[i].y);
    ctx.lineTo(points[i+1].x,points[i+1].y);
    ctx.stroke();
    i++;
    setTimeout(draw,150);
  }
  draw();
}

function clearLine(){
  ctx.clearRect(0,0,lineCanvas.width,lineCanvas.height);
}

/* ---------- POPUP ---------- */
popupOk.onclick=()=>{
  popup.style.display="none";
  stopFireworks();
  clearLine();
};

function showPopup(title,text,img){
  popupTitle.innerText=title+"\n"+text;
  popupImage.src=img||"";
  popup.style.display="flex";
}

/* ---------- FIREWORKS ---------- */
let fw;
function startFireworks(){
  const c=fireworks;
  const fctx=c.getContext("2d");
  c.width=innerWidth;
  c.height=innerHeight;
  fw=setInterval(()=>{
    fctx.fillStyle="rgba(0,0,0,.2)";
    fctx.fillRect(0,0,c.width,c.height);
    fctx.fillStyle="gold";
    fctx.beginPath();
    fctx.arc(Math.random()*c.width,Math.random()*c.height,4,0,Math.PI*2);
    fctx.fill();
  },50);
}

function stopFireworks(){
  clearInterval(fw);
  const c=fireworks;
  c.getContext("2d").clearRect(0,0,c.width,c.height);
}
</script>

</body>
</html>